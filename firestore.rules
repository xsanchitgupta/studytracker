rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for security
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isDMChat(chatId) {
      // DMs have format "userId1_userId2" with underscore separator
      return chatId.matches('.*_.*');
    }
    
    function isChatParticipant(chatId) {
      // For DMs: chatId format is "userId1_userId2"
      // Check if user's UID is in the chatId
      return isAuthenticated() && (
        chatId.matches('.*_' + request.auth.uid + '$') || 
        chatId.matches('^' + request.auth.uid + '_.*')
      );
    }
    
    function isValidMessageSize() {
      return !request.resource.data.keys().hasAny(['text']) || request.resource.data.text.size() <= 5000;
    }
    
    function isNotBlockedBy(otherUserId) {
      // Check if current user is blocked by the other user
      return !exists(/databases/$(database)/documents/users/$(otherUserId)/blockedUsers/$(request.auth.uid));
    }
    
    // Chats collection - handles both DMs and channels
    match /chats/{chatId} {
      // Chat metadata (typing status, etc.)
      allow read, write: if isAuthenticated();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Allow all authenticated users to read/list messages
        allow read, list: if isAuthenticated();
        
        // Allow create with sender validation
        allow create: if isAuthenticated() && 
                         request.resource.data.senderId == request.auth.uid;
        
        // Only message sender can update/delete their own messages
        allow update: if isAuthenticated() && 
                         resource.data.senderId == request.auth.uid;
        allow delete: if isAuthenticated() && 
                         resource.data.senderId == request.auth.uid;
      }
    }
    
    // Global admin playlists - readable by all authenticated users
    match /playlists_global/{playlistId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Reports collection - users can create reports, admins can read/write
    match /reports/{reportId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && 
                                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Channels collection - public channels with secure messaging
    match /channels/{channelId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                         request.resource.data.senderId == request.auth.uid &&
                         isValidMessageSize();
        allow update, delete: if isAuthenticated() && 
                                 (resource.data.senderId == request.auth.uid || isAdmin());
      }
    }
    
    // Users collection - allow read for all authenticated, write for own profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId;
      
      // User's personal playlists
      match /playlists/{playlistId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // User-specific data for admin playlists
      match /admin_playlist_data/{playlistId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // User's flashcards
      match /flashcards/{deckId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // User's goals
      match /goals/{goalId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // User's study logs
      match /study_logs/{logId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // Notifications subcollection - users can read/write their own, others can create
      match /notifications/{notificationId} {
        allow read, delete: if request.auth.uid == userId;
        allow update: if request.auth.uid == userId;
        allow create: if isAuthenticated();
      }
      
      // Blocked users subcollection - users can manage their own block list
      match /blockedUsers/{blockedUserId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // Privacy settings
      match /settings/privacy {
        allow read, write: if request.auth.uid == userId;
      }
      
      // Hidden messages - users can manage their own
      match /hiddenMessages/{messageId} {
        allow read, write: if request.auth.uid == userId;
      }
    }
  }
}